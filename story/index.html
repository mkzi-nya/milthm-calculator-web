<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Milthm å‰§æƒ…æ–‡æ¡£</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked-katex-extension/lib/index.umd.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      background: #0d1117;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .container {
      width: 100%;
      max-width: 900px;
    }

    .markdown-body {
      width: 100%;
      overflow-wrap: break-word;
    }

    .katex-display {
      display: block !important;
      text-align: center;
      margin: 10px 0;
      font-size: 1em;
    }

    .toc {
      display: none;
    }

    pre,
    code {
      user-select: text;
    }

    .loading {
      color: #8b949e;
      text-align: center;
      padding: 20px;
    }

    .error {
      color: #f85149;
      text-align: center;
      padding: 20px;
    }

    /* è¯­è¨€é€‰æ‹©å™¨æ ·å¼ */
    .language-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #222;
      padding: 5px;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      font-size: 2em;
      z-index: 1000;
    }

    .language-menu {
      display: none;
      position: absolute;
      top: 40px;
      right: 10px;
      background: #222;
      border-radius: 5px;
      padding: 10px;
      list-style: none;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .language-menu li {
      padding: 8px 12px;
      cursor: pointer;
      color: white;
    }

    .language-menu li:hover {
      background: #444;
    }
  </style>
</head>

<body>
  <!-- è¯­è¨€é€‰æ‹©æŒ‰é’® -->
  <div class="language-selector" onclick="toggleLanguageMenu()">ğŸŒ</div>
  <ul class="language-menu" id="language-menu">
    <li onclick="changeLanguage('zh_Hans')">ç®€ä½“ä¸­æ–‡</li>
    <li onclick="changeLanguage('zh_Hant')">ç¹é«”ä¸­æ–‡</li>
    <li onclick="changeLanguage('yue_Hant')">ç²µèª</li>
    <li onclick="changeLanguage('en')">English</li>
    <li onclick="changeLanguage('ja')">æ—¥æœ¬èª</li>
    <li onclick="changeLanguage('ko')">í•œêµ­ì–´</li>
    <li onclick="changeLanguage('ru')">Ğ ÑƒÑÑĞºĞ¸Ğ¹</li>
    <li onclick="changeLanguage('es')">EspaÃ±ol</li>
    <li onclick="changeLanguage('fr')">FranÃ§ais</li>
    <li onclick="changeLanguage('vi')">Tiáº¿ng Viá»‡t</li>
  </ul>

  <div class="container">
    <article id="content" class="markdown-body">
      <div class="loading">æ­£åœ¨åŠ è½½å‰§æƒ…æ–‡æ¡£...</div>
    </article>
  </div>

  <script>
    marked.use(markedKatex());
    marked.setOptions({
      highlight: (code, lang) => {
        if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
        return hljs.highlightAuto(code).value;
      }
    });

    // æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
    const supportedLanguages = [
      'zh_Hans', 'zh_Hant', 'yue_Hant', 'en', 'ja', 'ko', 'ru', 'es', 'fr', 'vi'
    ];

    // è¯­è¨€æ˜ å°„è¡¨ - ä¿®å¤æ˜ å°„å…³ç³»
    const languageMap = {
      // ç®€ä½“ä¸­æ–‡
      "zh": "zh_Hans",
      "zh-cn": "zh_Hans",
      "zh-hans-cn": "zh_Hans",
      "zh-hans": "zh_Hans",
      
      // ç¹ä½“ä¸­æ–‡
      "zh-tw": "zh_Hant",
      "zh-hk": "zh_Hant",
      "zh-mo": "zh_Hant",
      "zh-hant": "zh_Hant",
      "zh-hant-tw": "zh_Hant",
      "zh-hant-hk": "zh_Hant",
      
      // ç²¤è¯­
      "yue": "yue_Hant",
      "yue-hant": "yue_Hant",
      "yue-hk": "yue_Hant",
      
      // å…¶ä»–è¯­è¨€
      "en": "en",
      "ja": "ja",
      "ko": "ko",
      "ru": "ru",
      "es": "es",
      "fr": "fr",
      "vi": "vi"
    };

    // è·å–ç”¨æˆ·è¯­è¨€
    function getUserLanguage() {
      // é¦–å…ˆæ£€æŸ¥URLå‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      let lang = urlParams.get('lang');
      
      // å¦‚æœURLå‚æ•°å­˜åœ¨ä¸”æ˜¯æ”¯æŒçš„è¯­è¨€ï¼Œç›´æ¥ä½¿ç”¨
      if (lang && supportedLanguages.includes(lang)) {
        return lang;
      }
      
      // å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œåˆ™ä½¿ç”¨æµè§ˆå™¨è¯­è¨€
      if (!lang) {
        const browserLang = navigator.language.toLowerCase();
        console.log('æµè§ˆå™¨è¯­è¨€:', browserLang);
        
        // ç›´æ¥æ£€æŸ¥è¯­è¨€æ˜ å°„
        if (languageMap[browserLang]) {
          return languageMap[browserLang];
        }
        
        // æ£€æŸ¥è¯­è¨€ä»£ç çš„å‰ç¼€ï¼ˆå¦‚ zh-CN çš„å‰ç¼€æ˜¯ zhï¼‰
        const langPrefix = browserLang.split('-')[0];
        if (languageMap[langPrefix]) {
          return languageMap[langPrefix];
        }
      }
      
      // é»˜è®¤ä½¿ç”¨è‹±è¯­
      return "en";
    }

    // åŠ è½½Markdownæ–‡ä»¶
    function loadMarkdown() {
      const lang = getUserLanguage();
      const fileName = `${lang}.md`;
      console.log('å°è¯•åŠ è½½è¯­è¨€æ–‡ä»¶:', fileName);
      
      fetch(`./${fileName}`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.text();
        })
        .then(md => {
          document.getElementById('content').innerHTML = marked.parse(md, { 
            headerIds: true, 
            mangle: false 
          });
          document.querySelectorAll('h2,h3,h4').forEach(h => {
            h.id = h.innerText.toLowerCase().replace(/\s+/g, '-');
          });
          hljs.highlightAll();
          resizeKatex();
        })
        .catch((error) => {
          console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
          // å¦‚æœå½“å‰ä¸æ˜¯è‹±è¯­ï¼Œå°è¯•åŠ è½½è‹±è¯­ç‰ˆæœ¬
          if (lang !== "en") {
            console.log('å°è¯•åŠ è½½è‹±è¯­ç‰ˆæœ¬...');
            fetch('./en.md')
              .then(res => {
                if (!res.ok) throw new Error('è‹±è¯­æ–‡ä»¶ä¹Ÿæœªæ‰¾åˆ°');
                return res.text();
              })
              .then(md => {
                document.getElementById('content').innerHTML = marked.parse(md, { 
                  headerIds: true, 
                  mangle: false 
                });
                document.querySelectorAll('h2,h3,h4').forEach(h => {
                  h.id = h.innerText.toLowerCase().replace(/\s+/g, '-');
                });
                hljs.highlightAll();
                resizeKatex();
              })
              .catch(() => {
                document.getElementById('content').innerHTML = 
                  '<div class="error">æ— æ³•åŠ è½½å‰§æƒ…æ–‡æ¡£æ–‡ä»¶</div>';
              });
          } else {
            document.getElementById('content').innerHTML = 
              '<div class="error">æ— æ³•åŠ è½½å‰§æƒ…æ–‡æ¡£æ–‡ä»¶</div>';
          }
        });
    }

    function resizeKatex() {
      const w = document.querySelector('.markdown-body').clientWidth;
      document.querySelectorAll('.katex-display').forEach(e => {
        e.style.fontSize = ''; // æ¢å¤é»˜è®¤å¤§å°
        const actual = e.scrollWidth;
        if (actual > w) {
          const fs = parseFloat(getComputedStyle(e).fontSize);
          e.style.fontSize = (fs * w / actual) + 'px';
        }
      });
    }

    // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
    function toggleLanguageMenu() {
      const menu = document.getElementById("language-menu");
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }

    function changeLanguage(lang) {
      // æ›´æ–°URLå‚æ•°å¹¶é‡æ–°åŠ è½½é¡µé¢
      const url = new URL(window.location);
      url.searchParams.set('lang', lang);
      window.location.href = url.toString();
    }

    // åœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å¯¹åº”è¯­è¨€çš„mdæ–‡ä»¶
    window.addEventListener('load', loadMarkdown);

    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­è¯­è¨€èœå•
    document.addEventListener('click', function(event) {
      const menu = document.getElementById("language-menu");
      const selector = document.querySelector(".language-selector");
      if (menu.style.display === "block" && 
          !menu.contains(event.target) && 
          !selector.contains(event.target)) {
        menu.style.display = "none";
      }
    });
  </script>

</body>

</html>